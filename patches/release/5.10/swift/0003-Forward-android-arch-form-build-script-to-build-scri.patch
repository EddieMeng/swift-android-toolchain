From b898705c08e7d948ff8be393bffe580ca6b6c41e Mon Sep 17 00:00:00 2001
From: Andrew Druk <adruk@readdle.com>
Date: Thu, 6 Jun 2024 00:13:57 +0300
Subject: [PATCH 3/7] Forward android-arch form build-script to
 build-script-impl in case of i686

---
 utils/build-presets.ini                                  | 7 +++++++
 utils/build-script                                       | 3 +++
 utils/build_swift/build_swift/driver_arguments.py        | 4 ++--
 utils/swift_build_support/swift_build_support/targets.py | 2 +-
 4 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/utils/build-presets.ini b/utils/build-presets.ini
index d90036a548f..50d65263be0 100644
--- a/utils/build-presets.ini
+++ b/utils/build-presets.ini
@@ -1021,6 +1021,13 @@ llbuild
 swift-driver
 install-all
 
+[preset: buildbot_linux_crosscompile_android,tools=RA,stdlib=RD,build,armv7]
+mixin-preset=buildbot_linux_crosscompile_android,tools=RA,stdlib=RD,build
+
+dash-dash
+
+android-arch=armv7
+
 [preset: buildbot_linux_crosscompile_android,tools=RA,stdlib=RD,build,aarch64]
 mixin-preset=buildbot_linux_crosscompile_android,tools=RA,stdlib=RD,build
 
diff --git a/utils/build-script b/utils/build-script
index dcbc3915489..8951400b5a9 100755
--- a/utils/build-script
+++ b/utils/build-script
@@ -357,6 +357,9 @@ def apply_default_arguments(toolchain, args):
         elif args.android_arch == "aarch64":
             args.stdlib_deployment_targets.append(
                 StdlibDeploymentTarget.Android.aarch64.name)
+        elif args.android_arch == "i686":
+            args.stdlib_deployment_targets.append(
+                StdlibDeploymentTarget.Android.i686.name)
         elif args.android_arch == "x86_64":
             args.stdlib_deployment_targets.append(
                 StdlibDeploymentTarget.Android.x86_64.name)
diff --git a/utils/build_swift/build_swift/driver_arguments.py b/utils/build_swift/build_swift/driver_arguments.py
index 15f2ff04f43..79f1434683d 100644
--- a/utils/build_swift/build_swift/driver_arguments.py
+++ b/utils/build_swift/build_swift/driver_arguments.py
@@ -1306,10 +1306,10 @@ def create_argument_parser():
                     android.adb.commands.DEVICE_TEMP_DIR))
 
     option('--android-arch', store,
-           choices=['armv7', 'aarch64', 'x86_64'],
+           choices=['armv7', 'aarch64', 'i686', 'x86_64'],
            default='armv7',
            help='The target architecture when building for Android. '
-                'Currently, only armv7, aarch64, and x86_64 are supported. '
+                'Currently, only armv7, aarch64, i686, and x86_64 are supported. '
                 '%(default)s is the default.')
 
     # -------------------------------------------------------------------------
diff --git a/utils/swift_build_support/swift_build_support/targets.py b/utils/swift_build_support/swift_build_support/targets.py
index 588ba88161d..fe82df5a8ec 100644
--- a/utils/swift_build_support/swift_build_support/targets.py
+++ b/utils/swift_build_support/swift_build_support/targets.py
@@ -284,7 +284,7 @@ class StdlibDeploymentTarget(object):
 
     Cygwin = Platform("cygwin", archs=["x86_64"])
 
-    Android = AndroidPlatform("android", archs=["armv7", "aarch64", "x86_64"])
+    Android = AndroidPlatform("android", archs=["armv7", "aarch64", "i686", "x86_64"])
 
     Windows = Platform("windows", archs=["x86_64"])
 
-- 
2.41.0

